<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Scrabble Score Tracker</title>
    <style>
        :root {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        body {
            margin: 0;
            background: #f6f7fb;
            color: #111;
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 20px;
            margin: 0;
        }

        .sub {
            font-size: 13px;
            opacity: .75;
        }

        .pill {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #eef2ff;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .06);
            transition: opacity .15s ease;
        }

        .topGrid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .total {
            font-size: 44px;
            font-weight: 750;
            margin: 8px 0 0;
        }

        .row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        input[type="number"] {
            width: 140px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e3e6ef;
            font-size: 14px;
        }

        input[type="text"] {
            flex: 1;
            min-width: 220px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e3e6ef;
            font-size: 14px;
        }

        select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e3e6ef;
            font-size: 14px;
            background: #fff;
        }

        input:disabled {
            background: #f3f4f6;
            color: #6b7280;
        }

        button {
            padding: 10px 12px;
            border-radius: 10px;
            border: 0;
            background: #111827;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        button.secondary {
            background: #e5e7eb;
            color: #111;
        }

        button.danger {
            background: #ef4444;
        }

        button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 10px 8px;
            border-bottom: 1px solid #eef0f6;
            font-size: 14px;
        }

        th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .06em;
            opacity: .7;
        }

        .muted {
            opacity: .7;
        }

        .footer {
            margin-top: 18px;
            font-size: 12px;
            opacity: .7;
        }

        canvas {
            width: 100%;
            height: 260px;
            display: block;
        }

        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .legendItem {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
        }

        .swatch {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            background: #000;
        }

        .hidden {
            display: none !important;
        }

        .win {
            outline: 2px solid #22c55e33;
        }

        .activeTurn {
            outline: 2px solid rgba(17, 24, 39, 0.18);
            box-shadow: 0 10px 28px rgba(0, 0, 0, .08);
            opacity: 1 !important;
        }

        .modalBackdrop {
            position: fixed;
            inset: 0;
            background: rgba(17, 24, 39, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .modalBackdrop.show {
            display: flex;
        }

        .modal {
            width: min(760px, 100%);
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 24px 60px rgba(0, 0, 0, .25);
            padding: 16px;
        }

        .modalHeader {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .modalHeader strong {
            font-size: 16px;
        }

        .modalGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        @media (max-width: 700px) {
            .modalGrid {
                grid-template-columns: 1fr;
            }
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-size: 12px;
            opacity: .75;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .modalActions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .hint {
            font-size: 12px;
            opacity: .75;
            margin-top: 10px;
        }

        .checkline {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            opacity: .85;
        }

        .roundRow td {
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            border-top: 2px solid #e5e7eb;
            font-weight: 700;
            letter-spacing: .02em;
        }

        .roundRow td span {
            font-weight: 600;
            opacity: .7;
            margin-left: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div>
            <h1>Scrabble Score Tracker</h1>
            <div class="sub">Up to 4 players (players 3–4 optional). Tracks turns, totals, and a score progression
                chart. Saves locally.
            </div>
        </div>
        <div class="pill" id="statusPill">Ready</div>
    </header>

    <section class="topGrid" aria-label="Chart">
        <div class="card">
            <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <strong>Score progression</strong>
                <span class="muted" id="chartMeta">-</span>
            </div>
            <div style="margin-top: 10px;">
                <canvas id="chart" width="1200" height="520" aria-label="Line chart of cumulative scores"></canvas>
            </div>
            <div class="legend" id="legend" aria-label="Chart legend"></div>
        </div>
    </section>

    <section class="grid" aria-label="Scorecards">
        <div class="card" id="card-player1">
            <div class="name">
                <strong id="label-player1">Player 1</strong>
                <span class="pill" id="lead-player1">-</span>
            </div>
            <div class="total" id="total-player1">0</div>
            <div class="row">
                <label for="score-player1"></label><input id="score-player1" type="number" inputmode="numeric"
                                                          placeholder="+ points"/>
                <label for="note-player1"></label><input id="note-player1" type="text"
                                                         placeholder="note (optional) e.g., QUIZ +50"/>
                <button id="add-player1">Add turn</button>
            </div>
        </div>

        <div class="card" id="card-player2">
            <div class="name">
                <strong id="label-player2">Player 2</strong>
                <span class="pill" id="lead-player2">-</span>
            </div>
            <div class="total" id="total-player2">0</div>
            <div class="row">
                <label for="score-player2"></label><input id="score-player2" type="number" inputmode="numeric"
                                                          placeholder="+ points"/>
                <label for="note-player2"></label><input id="note-player2" type="text"
                                                         placeholder="note (optional) e.g., JAZZ +64"/>
                <button id="add-player2">Add turn</button>
            </div>
        </div>

        <div class="card hidden" id="card-player3">
            <div class="name">
                <strong id="label-player3">Player 3</strong>
                <span class="pill" id="lead-player3">-</span>
            </div>
            <div class="total" id="total-player3">0</div>
            <div class="row">
                <label for="score-player3"></label><input id="score-player3" type="number" inputmode="numeric"
                                                          placeholder="+ points"/>
                <label for="note-player3"></label><input id="note-player3" type="text" placeholder="note (optional)"/>
                <button id="add-player3">Add turn</button>
            </div>
        </div>

        <div class="card hidden" id="card-player4">
            <div class="name">
                <strong id="label-player4">Player 4</strong>
                <span class="pill" id="lead-player4">-</span>
            </div>
            <div class="total" id="total-player4">0</div>
            <div class="row">
                <label for="score-player4"></label><input id="score-player4" type="number" inputmode="numeric"
                                                          placeholder="+ points"/>
                <label for="note-player4"></label><input id="note-player4" type="text" placeholder="note (optional)"/>
                <button id="add-player4">Add turn</button>
            </div>
        </div>
    </section>

    <section class="card" style="margin-top:16px;" aria-label="Turn history">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <strong>Turn history</strong>
            <span class="muted" id="turnCount">0 turns</span>
        </div>

        <div class="controls">
            <button class="secondary" id="undoBtn" disabled>Undo last turn</button>
            <button class="secondary" id="exportBtn">Export JSON</button>
            <button class="secondary" id="editNamesBtn">Edit players</button>
            <button class="danger" id="resetBtn">Reset game</button>
        </div>

        <div style="overflow:auto; margin-top:10px;">
            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Player</th>
                    <th>Score</th>
                    <th>Note</th>
                    <th class="muted">Time</th>
                </tr>
                </thead>
                <tbody id="historyBody">
                <tr>
                    <td colspan="5" class="muted">No turns yet.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            Tip: The game saves in your browser (localStorage). Different devices/browsers won't share state.
            | <a href="https://buymeacoffee.com/pivovarit" target="_blank" rel="noopener">Buy me a coffee</a>
        </div>
    </section>
</div>

<div class="modalBackdrop" id="nameModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="nameModalTitle">
    <div class="modal">
        <div class="modalHeader">
            <strong id="nameModalTitle">Choose players</strong>
            <span class="pill muted" id="modalBadge">One-time setup</span>
        </div>

        <div class="modalGrid">
            <div class="field">
                <label for="name-player1">Player 1</label>
                <input id="name-player1" type="text" value=""/>
            </div>
            <div class="field">
                <label for="name-player2">Player 2</label>
                <input id="name-player2" type="text" value=""/>
            </div>

            <div class="field">
                <label for="name-player3">
                    Player 3
                    <span class="checkline"><input id="enable-player3" type="checkbox"/> Enable</span>
                </label>
                <input id="name-player3" type="text" value="" placeholder="Optional"/>
            </div>

            <div class="field">
                <label for="name-player4">
                    Player 4
                    <span class="checkline"><input id="enable-player4" type="checkbox"/> Enable</span>
                </label>
                <input id="name-player4" type="text" value="" placeholder="Optional"/>
            </div>

            <div class="field" style="grid-column: 1 / -1;">
                <label for="startingPlayerSelect">Starting player</label>
                <select id="startingPlayerSelect"></select>
            </div>
        </div>

        <div class="hint">Names are shown in the UI and history. Players 3–4 are hidden unless enabled.</div>

        <div class="modalActions">
            <button class="secondary" id="modalUseDefaultsBtn" type="button">Use defaults</button>
            <button id="modalSaveBtn" type="button">Start game</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = "scrabble_tracker_v7_turns";
    const PLAYER_KEYS = ["player1", "player2", "player3", "player4"];
    const COLORS = {player1: "#2563eb", player2: "#db2777", player3: "#16a34a", player4: "#f59e0b"};

    const state = {
        players: {
            player1: {name: "", total: 0, enabled: true},
            player2: {name: "", total: 0, enabled: true},
            player3: {name: "", total: 0, enabled: false},
            player4: {name: "", total: 0, enabled: false}
        },
        turns: [],
        namesLocked: false,
        currentPlayerKey: "player1"
    };

    const el = (id) => document.getElementById(id);

    function enabledPlayers() {
        return PLAYER_KEYS.filter(k => state.players[k].enabled);
    }

    function displayName(k) {
        const n = (state.players[k].name || "").trim();
        if (n) return n;
        return k === "player1" ? "Player 1" : k === "player2" ? "Player 2" : k === "player3" ? "Player 3" : "Player 4";
    }

    function modalName(k) {
        const input = el(`name-${k}`);
        const n = input ? (input.value || "").trim() : "";
        if (n) return n;
        return k === "player1" ? "Player 1" : k === "player2" ? "Player 2" : k === "player3" ? "Player 3" : "Player 4";
    }

    function modalEnabledKeys() {
        const keys = ["player1", "player2"];
        if (el("enable-player3")?.checked) keys.push("player3");
        if (el("enable-player4")?.checked) keys.push("player4");
        return keys;
    }

    function turnOrder() {
        const keys = enabledPlayers();
        return keys.length ? keys : ["player1", "player2"];
    }

    function clampCurrentPlayer() {
        const keys = turnOrder();
        if (!keys.includes(state.currentPlayerKey)) state.currentPlayerKey = keys[0];
    }

    function nextPlayerKey(fromKey) {
        const keys = turnOrder();
        const idx = keys.indexOf(fromKey);
        if (idx === -1) return keys[0];
        return keys[(idx + 1) % keys.length];
    }

    function focusPlayer(k) {
        const scoreEl = el(`score-${k}`);
        if (!scoreEl) return;
        setTimeout(() => {
            scoreEl.focus();
            if (typeof scoreEl.select === "function") scoreEl.select();
        }, 0);
    }

    function updateStatusPillNow() {
        clampCurrentPlayer();
        el("statusPill").textContent = `Turn: ${displayName(state.currentPlayerKey)}`;
    }

    function setStatus(msg) {
        el("statusPill").textContent = msg;
        window.clearTimeout(setStatus._t);
        setStatus._t = window.setTimeout(() => updateStatusPillNow(), 1500);
    }

    function load() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== "object") return;

            for (const k of PLAYER_KEYS) {
                if (parsed.players?.[k]) {
                    const p = parsed.players[k];
                    if (typeof p.name === "string") state.players[k].name = p.name;
                    if (typeof p.enabled === "boolean") state.players[k].enabled = p.enabled;
                }
            }

            state.turns = Array.isArray(parsed.turns) ? parsed.turns : [];
            state.namesLocked = Boolean(parsed.namesLocked);
            if (typeof parsed.currentPlayerKey === "string") state.currentPlayerKey = parsed.currentPlayerKey;

            for (const k of PLAYER_KEYS) state.players[k].total = 0;
            for (const t of state.turns) {
                const k = t.playerKey;
                if (state.players[k]) state.players[k].total += Number(t.delta) || 0;
            }

            clampCurrentPlayer();
        } catch (_) {
        }
    }

    function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function fmtTime(ts) {
        const d = new Date(ts);
        return d.toLocaleString(undefined, {
            hour: "2-digit",
            minute: "2-digit",
            year: "numeric",
            month: "short",
            day: "2-digit"
        });
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    function syncStartingPlayerSelect(preferKey, useModal) {
        const sel = el("startingPlayerSelect");
        const keys = useModal ? modalEnabledKeys() : enabledPlayers();
        const prev = sel.value || preferKey || state.currentPlayerKey || "player1";
        sel.innerHTML = "";
        for (const k of keys) {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = useModal ? modalName(k) : displayName(k);
            sel.appendChild(opt);
        }
        sel.value = keys.includes(prev) ? prev : (keys[0] || "player1");
    }

    function applyPlayersToUI() {
        clampCurrentPlayer();

        for (const k of PLAYER_KEYS) {
            el(`label-${k}`).textContent = displayName(k);

            const enabled = state.players[k].enabled;
            const isActive = enabled && state.currentPlayerKey === k;

            el(`card-${k}`).classList.toggle("hidden", !enabled);
            el(`card-${k}`).classList.toggle("activeTurn", isActive);

            const score = el(`score-${k}`);
            const note = el(`note-${k}`);
            const btn = el(`add-${k}`);

            const disabled = !isActive;

            score.disabled = disabled;
            note.disabled = disabled;
            btn.disabled = disabled;

            el(`card-${k}`).style.opacity = enabled ? (isActive ? "1" : "0.65") : "1";
        }

        const legend = el("legend");
        legend.innerHTML = "";
        for (const k of enabledPlayers()) {
            const item = document.createElement("div");
            item.className = "legendItem";
            const sw = document.createElement("span");
            sw.className = "swatch";
            sw.style.background = COLORS[k];
            const txt = document.createElement("span");
            txt.textContent = displayName(k);
            item.appendChild(sw);
            item.appendChild(txt);
            legend.appendChild(item);
        }

        el("name-player1").value = state.players.player1.name;
        el("name-player2").value = state.players.player2.name;
        el("name-player3").value = state.players.player3.name;
        el("name-player4").value = state.players.player4.name;
        el("enable-player3").checked = state.players.player3.enabled;
        el("enable-player4").checked = state.players.player4.enabled;

        el("name-player3").disabled = !el("enable-player3").checked;
        el("name-player4").disabled = !el("enable-player4").checked;
    }

    function updateLeadersUI() {
        for (const k of PLAYER_KEYS) {
            el(`card-${k}`).classList.remove("win");
            el(`lead-${k}`).textContent = "-";
        }

        const keys = enabledPlayers();
        const totals = keys.map(k => state.players[k].total);
        const max = Math.max(...totals, 0);
        const leaders = keys.filter(k => state.players[k].total === max);

        for (const k of keys) {
            const t = state.players[k].total;
            const pill = el(`lead-${k}`);
            if (leaders.length > 1) {
                pill.textContent = leaders.includes(k) ? "Tied for lead" : `Behind by ${max - t}`;
            } else {
                pill.textContent = leaders[0] === k ? "Leading" : `Behind by ${max - t}`;
            }
        }

        for (const k of leaders) el(`card-${k}`).classList.add("win");
    }

    function addTurn(playerKey) {
        if (playerKey !== state.currentPlayerKey) {
            setStatus(`It's ${displayName(state.currentPlayerKey)}'s turn`);
            focusPlayer(state.currentPlayerKey);
            return;
        }

        if (!state.players[playerKey]?.enabled) return;

        const scoreEl = el(`score-${playerKey}`);
        const noteEl = el(`note-${playerKey}`);

        const raw = String(scoreEl.value ?? "").trim();
        if (raw === "") {
            setStatus("Enter a score (0 allowed)");
            scoreEl.focus();
            return;
        }

        const delta = Number(raw);
        if (!Number.isFinite(delta) || delta < 0) {
            setStatus("Enter a non-negative score");
            scoreEl.focus();
            return;
        }

        const note = noteEl.value.trim();

        const turn = {
            id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
            playerKey,
            delta,
            note,
            ts: Date.now()
        };

        state.turns.push(turn);
        state.players[playerKey].total += delta;

        scoreEl.value = "";
        noteEl.value = "";

        const next = nextPlayerKey(playerKey);
        state.currentPlayerKey = next;

        save();
        render();

        setStatus(`Added ${displayName(playerKey)} +${delta}`);
        focusPlayer(next);
    }

    function undo() {
        const t = state.turns.pop();
        if (!t) return;

        if (state.players[t.playerKey]) state.players[t.playerKey].total -= t.delta;

        state.currentPlayerKey = t.playerKey;
        clampCurrentPlayer();

        save();
        render();
        setStatus("Undid last turn");
        focusPlayer(state.currentPlayerKey);
    }

    function resetGame() {
        if (!confirm("Reset the game? This clears scores and history.")) return;

        state.turns = [];
        for (const k of PLAYER_KEYS) state.players[k].total = 0;
        for (const k of PLAYER_KEYS) state.players[k].name = "";

        state.players.player1.enabled = true;
        state.players.player2.enabled = true;
        state.players.player3.enabled = false;
        state.players.player4.enabled = false;

        state.namesLocked = false;
        state.currentPlayerKey = "player1";

        save();
        render();
        openPlayersModal(true);
        setStatus("Game reset");
    }

    function exportJson() {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `scrabble-game-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus("Exported JSON");
    }

    function openPlayersModal(isInitial) {
        applyPlayersToUI();
        el("nameModalBackdrop").classList.add("show");
        el("modalBadge").textContent = isInitial ? "One-time setup" : "Edit players";
        syncStartingPlayerSelect(state.currentPlayerKey, true);
        setTimeout(() => el("name-player1").focus(), 0);
    }

    function closePlayersModal() {
        el("nameModalBackdrop").classList.remove("show");
    }

    function normalizeEnabledPlayers() {
        state.players.player1.enabled = true;
        state.players.player2.enabled = true;
    }

    function savePlayersAndLock() {
        state.players.player1.name = (el("name-player1").value || "").trim();
        state.players.player2.name = (el("name-player2").value || "").trim();

        state.players.player3.enabled = Boolean(el("enable-player3").checked);
        state.players.player4.enabled = Boolean(el("enable-player4").checked);

        state.players.player3.name = (el("name-player3").value || "").trim();
        state.players.player4.name = (el("name-player4").value || "").trim();

        normalizeEnabledPlayers();

        const chosenStart = el("startingPlayerSelect").value;
        const keys = enabledPlayers();
        state.currentPlayerKey = keys.includes(chosenStart) ? chosenStart : (keys[0] || "player1");

        state.namesLocked = true;
        save();
        render();
        closePlayersModal();
        setStatus("Players saved");
        focusPlayer(state.currentPlayerKey);
    }

    function useDefaultsAndLock() {
        el("name-player1").value = "";
        el("name-player2").value = "";
        el("enable-player3").checked = false;
        el("enable-player4").checked = false;
        el("name-player3").value = "";
        el("name-player4").value = "";
        el("name-player3").disabled = true;
        el("name-player4").disabled = true;
        syncStartingPlayerSelect("player1", true);
        savePlayersAndLock();
    }

    el("nameModalBackdrop").addEventListener("click", (e) => {
        if (e.target !== el("nameModalBackdrop")) return;
        if (!state.namesLocked) return;
        closePlayersModal();
    });

    window.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        if (!el("nameModalBackdrop").classList.contains("show")) return;
        if (!state.namesLocked) return;
        closePlayersModal();
    });

    function buildSeries() {
        const keys = enabledPlayers();
        const n = state.turns.length;
        const x = Array.from({length: n + 1}, (_, i) => i);

        const y = {};
        for (const k of keys) y[k] = [0];

        const totals = {};
        for (const k of keys) totals[k] = 0;

        for (const t of state.turns) {
            const pk = t.playerKey;
            if (totals[pk] == null) continue;
            totals[pk] += Number(t.delta) || 0;
            for (const k of keys) y[k].push(totals[k]);
        }

        if (n === 0) for (const k of keys) y[k] = [0];

        return {x, y, n, keys};
    }

    function drawChart() {
        const canvas = el("chart");
        const ctx = canvas.getContext("2d");

        const cssW = canvas.clientWidth;
        const cssH = canvas.clientHeight;
        const dpr = window.devicePixelRatio || 1;
        const targetW = Math.round(cssW * dpr);
        const targetH = Math.round(cssH * dpr);
        if (canvas.width !== targetW || canvas.height !== targetH) {
            canvas.width = targetW;
            canvas.height = targetH;
        }

        const W = canvas.width;
        const H = canvas.height;
        ctx.clearRect(0, 0, W, H);

        const pad = {l: 56, r: 18, t: 18, b: 44};
        const plotW = W - pad.l - pad.r;
        const plotH = H - pad.t - pad.b;

        const {x, y, n, keys} = buildSeries();

        const allVals = keys.flatMap(k => y[k] || []);
        const maxY = Math.max(10, ...allVals);
        const minY = 0;

        const xToPx = (xi) => pad.l + (plotW * (n === 0 ? 0 : (xi / n)));
        const yToPx = (yv) => pad.t + plotH * (1 - (yv - minY) / (maxY - minY));

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, W, H);

        ctx.strokeStyle = "#eef0f6";
        ctx.lineWidth = 1;

        const yTicks = 5;
        for (let i = 0; i <= yTicks; i++) {
            const val = minY + (i * (maxY - minY)) / yTicks;
            const py = yToPx(val);

            ctx.beginPath();
            ctx.moveTo(pad.l, py);
            ctx.lineTo(W - pad.r, py);
            ctx.stroke();

            ctx.fillStyle = "#6b7280";
            ctx.font = `${Math.round(12 * dpr)}px system-ui`;
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(String(Math.round(val)), pad.l - 10, py);
        }

        ctx.strokeStyle = "#e3e6ef";
        ctx.beginPath();
        ctx.moveTo(pad.l, H - pad.b);
        ctx.lineTo(W - pad.r, H - pad.b);
        ctx.stroke();

        const labelPoints = n <= 2 ? x : [0, Math.round(n / 2), n];
        ctx.fillStyle = "#6b7280";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.font = `${Math.round(12 * dpr)}px system-ui`;
        for (const lp of labelPoints) {
            const px = xToPx(lp);
            ctx.fillText(lp === 0 ? "Start" : `Turn ${lp}`, px, H - pad.b + 10);
        }

        function drawLine(series, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3 * dpr;
            ctx.lineJoin = "round";
            ctx.lineCap = "round";
            ctx.beginPath();
            series.forEach((val, i) => {
                const px = xToPx(x[i]);
                const py = yToPx(val);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();

            ctx.fillStyle = color;
            for (let i = 0; i < series.length; i++) {
                const px = xToPx(x[i]);
                const py = yToPx(series[i]);
                ctx.beginPath();
                ctx.arc(px, py, 4.5 * dpr, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (const k of keys) {
            const series = y[k] || [];
            if (series.length) drawLine(series, COLORS[k]);
        }

        el("chartMeta").textContent = n === 0 ? "No turns yet" : `Showing ${n} turn${n === 1 ? "" : "s"} (cumulative totals)`;
    }

    function render() {
        applyPlayersToUI();

        for (const k of PLAYER_KEYS) {
            el(`total-${k}`).textContent = state.players[k].total;
        }

        el("turnCount").textContent = `${state.turns.length} turn${state.turns.length === 1 ? "" : "s"}`;
        el("undoBtn").disabled = state.turns.length === 0;

        const body = el("historyBody");
        body.innerHTML = "";

        const keys = enabledPlayers();
        const perRound = Math.max(1, keys.length);

        if (state.turns.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="5" class="muted">No turns yet.</td>`;
            body.appendChild(tr);
        } else {
            state.turns.forEach((t, idx) => {
                if (idx % perRound === 0) {
                    const roundNum = Math.floor(idx / perRound) + 1;
                    const trRound = document.createElement("tr");
                    trRound.className = "roundRow";
                    const startIdx = idx + 1;
                    const endIdx = Math.min(idx + perRound, state.turns.length);
                    trRound.innerHTML = `<td colspan="5">Round ${roundNum}<span>Turns ${startIdx}–${endIdx}</span></td>`;
                    body.appendChild(trRound);
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(displayName(t.playerKey))}</td>
          <td>+${t.delta}</td>
          <td>${t.note ? escapeHtml(t.note) : "<span class='muted'>-</span>"}</td>
          <td class="muted">${fmtTime(t.ts)}</td>
        `;
                body.appendChild(tr);
            });
        }

        updateLeadersUI();
        drawChart();
        updateStatusPillNow();
    }

    function wire() {
        for (const k of PLAYER_KEYS) {
            el(`add-${k}`).addEventListener("click", () => addTurn(k));
            el(`score-${k}`).addEventListener("keydown", (e) => {
                if (e.key === "Enter") addTurn(k);
            });
            el(`note-${k}`).addEventListener("keydown", (e) => {
                if (e.key === "Enter") addTurn(k);
            });

            el(`card-${k}`).addEventListener("click", () => {
                if (!state.players[k].enabled) return;
                state.currentPlayerKey = k;
                save();
                render();
                focusPlayer(k);
            });
        }

        el("undoBtn").addEventListener("click", undo);
        el("resetBtn").addEventListener("click", resetGame);
        el("exportBtn").addEventListener("click", exportJson);
        el("editNamesBtn").addEventListener("click", () => openPlayersModal(false));

        el("modalSaveBtn").addEventListener("click", savePlayersAndLock);
        el("modalUseDefaultsBtn").addEventListener("click", useDefaultsAndLock);

        ["name-player1", "name-player2", "name-player3", "name-player4"].forEach(id => {
            el(id).addEventListener("keydown", (e) => {
                if (e.key === "Enter") savePlayersAndLock();
            });
            el(id).addEventListener("input", () => syncStartingPlayerSelect(el("startingPlayerSelect").value, true));
        });

        el("enable-player3").addEventListener("change", () => {
            el("name-player3").disabled = !el("enable-player3").checked;
            if (!el("enable-player3").checked) el("name-player3").value = "";
            syncStartingPlayerSelect(el("startingPlayerSelect").value, true);
        });

        el("enable-player4").addEventListener("change", () => {
            el("name-player4").disabled = !el("enable-player4").checked;
            if (!el("enable-player4").checked) el("name-player4").value = "";
            syncStartingPlayerSelect(el("startingPlayerSelect").value, true);
        });

        window.addEventListener("resize", () => drawChart());
    }

    load();
    wire();
    render();
    if (!state.namesLocked) openPlayersModal(true);
    focusPlayer(state.currentPlayerKey);
</script>
</body>
</html>
